name: ğŸš€ Deploy to Production (VPS)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  # Test & Migrations
  test:
    name: Test & Migrations
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ”¨ Build Backend
        working-directory: ./backend
        run: npm run build

      - name: ğŸ§ª Run Backend Tests
        working-directory: ./backend
        run: |
          if npm run | grep -q "test"; then
            npm test -- --passWithNoTests
          else
            echo "No test script found, skipping tests"
          fi
        continue-on-error: true

  # Build Backend Docker Image
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: test

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/aegg-backend
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  # Build Frontend Docker Image
  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: test

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/aegg-frontend
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            VITE_API_URL=${{ secrets.API_URL }}

  # Deploy to VPS
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‚ Copy deployment files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "deploy/docker-compose.prod.yml,deploy/deploy.sh"
          target: "/opt/aegg"
          strip_components: 1

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script_stop: true
          # Pass secrets as environment variables to the script
          envs: GITHUB_REPOSITORY,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,API_URL,LETSENCRYPT_EMAIL,TRAEFIK_BASIC_AUTH
          script: |
            export GITHUB_REPOSITORY=${{ github.repository }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export API_URL=${{ secrets.API_URL }}
            export FRONTEND_URL=${{ secrets.FRONTEND_URL || 'https://aegg.creapolis.mx' }}
            export LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
            export TRAEFIK_BASIC_AUTH=${{ secrets.TRAEFIK_BASIC_AUTH }}
            
            cd /opt/aegg
            chmod +x deploy.sh
            ./deploy.sh

      - name: âœ… Notify Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment completado exitosamente"
          echo "Backend: ${{ secrets.API_URL }}"
          echo "Frontend: https://aegg.creapolis.mx"

      - name: âŒ Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ El deployment fallÃ³. Por favor revisa los logs:"
          echo "VPS: ${{ secrets.VPS_HOST }}"
          echo "Revisa los logs con: docker-compose -f /opt/aegg/docker-compose.prod.yml logs -f"
