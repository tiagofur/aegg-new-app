name: ğŸš€ Deploy Frontend to Production

# Deploy automÃ¡tico cuando haces push a la rama production
on:
  push:
    branches:
      - production
  workflow_dispatch:  # Permite deployment manual desde GitHub

jobs:
  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ—ï¸ Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://aegg-api.creapolis.mx

      - name: ğŸš€ Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ”„ Deploying frontend..."
            
            # Backup actual
            cd /var/www/vhosts/creapolis.mx/aegg
            if [ -d "httpdocs" ]; then
              cp -r httpdocs httpdocs.backup.$(date +%Y%m%d-%H%M%S)
              # Mantener solo Ãºltimos 5 backups
              ls -dt httpdocs.backup.* | tail -n +6 | xargs rm -rf
            fi
            
            # Pull latest code
            git fetch origin
            git reset --hard origin/production
            
            # Build frontend
            cd frontend
            npm ci
            npm run build
            
            # Deploy
            rm -rf /var/www/vhosts/creapolis.mx/aegg/httpdocs/*
            cp -r dist/* /var/www/vhosts/creapolis.mx/aegg/httpdocs/
            
            echo "âœ… Frontend deployed successfully!"

      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Frontend deployed to https://aegg.creapolis.mx"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "ğŸ’¥ Deployment failed. Check logs above."
