<!DOCTYPE html>
<html>
  <head>
    <title>Diagnóstico de Autenticación</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .token-info {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .valid {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .invalid {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      .restore-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
      }
      .clear-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>Diagnóstico de Autenticación</h1>

    <div id="tokenInfo"></div>

    <h3>Acciones:</h3>
    <button class="restore-btn" onclick="restoreValidToken()">
      Restaurar Token Válido
    </button>
    <button class="clear-btn" onclick="clearAuth()">
      Limpiar Autenticación
    </button>
    <button onclick="testAPI()">Probar API</button>

    <div id="apiResult"></div>

    <script>
      function displayTokenInfo() {
        const token = localStorage.getItem("token");
        const user = localStorage.getItem("user");
        const tokenInfo = document.getElementById("tokenInfo");

        if (token && user) {
          try {
            const userObj = JSON.parse(user);
            tokenInfo.innerHTML = `
                        <div class="token-info valid">
                            <h3>✅ Autenticación Encontrada</h3>
                            <p><strong>Usuario:</strong> ${userObj.name} (${
              userObj.email
            })</p>
                            <p><strong>Token:</strong> ${token.substring(
                              0,
                              50
                            )}...</p>
                        </div>
                    `;
          } catch (e) {
            tokenInfo.innerHTML = `
                        <div class="token-info invalid">
                            <h3>❌ Datos Corruptos</h3>
                            <p>Token existe pero datos de usuario inválidos</p>
                        </div>
                    `;
          }
        } else {
          tokenInfo.innerHTML = `
                    <div class="token-info invalid">
                        <h3>❌ No Autenticado</h3>
                        <p>No se encontró token o información de usuario</p>
                    </div>
                `;
        }
      }

      function restoreValidToken() {
        // Token válido generado anteriormente con el secreto correcto
        const validToken =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlMTdiYzkxOS0zMmZkLTQ1NGEtODE2NS01OGI4OTJhMmVkYTkiLCJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJpYXQiOjE3NTk4MDQ5NTksImV4cCI6MTc2MDQwOTc1OX0.QFoGRE7mCGNmojfZ_le-DxhtkG820OV2KF0RveexytY";
        const validUser = {
          id: "e17bc919-32fd-454a-8165-58b892a2eda9",
          email: "test@test.com",
          name: "Test User",
        };

        localStorage.setItem("token", validToken);
        localStorage.setItem("user", JSON.stringify(validUser));

        alert("Token válido restaurado");
        displayTokenInfo();
      }

      function clearAuth() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        alert("Autenticación limpiada");
        displayTokenInfo();
      }

      async function testAPI() {
        const apiResult = document.getElementById("apiResult");
        const token = localStorage.getItem("token");

        if (!token) {
          apiResult.innerHTML =
            '<div class="token-info invalid">No hay token para probar</div>';
          return;
        }

        try {
          const response = await fetch("http://localhost:3000/trabajos", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            apiResult.innerHTML = `
                        <div class="token-info valid">
                            <h3>✅ API Funcionando</h3>
                            <p>Status: ${response.status}</p>
                            <p>Trabajos encontrados: ${data.length}</p>
                        </div>
                    `;
          } else {
            apiResult.innerHTML = `
                        <div class="token-info invalid">
                            <h3>❌ Error API</h3>
                            <p>Status: ${response.status}</p>
                            <p>Error: ${await response.text()}</p>
                        </div>
                    `;
          }
        } catch (error) {
          apiResult.innerHTML = `
                    <div class="token-info invalid">
                        <h3>❌ Error de Conexión</h3>
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      // Mostrar información al cargar
      displayTokenInfo();
    </script>
  </body>
</html>
