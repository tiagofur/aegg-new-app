# GitHub Configuration Guide for AEGG Application

Complete guide for configuring GitHub repository for CI/CD with automatic VPS deployment.

## ğŸ“‹ Table of Contents

1. [Repository Setup](#repository-setup)
2. [GitHub Secrets Configuration](#github-secrets-configuration)
3. [GitHub Actions Workflows](#github-actions-workflows)
4. [Container Registry Setup](#container-registry-setup)
5. [Testing CI/CD](#testing-cicd)
6. [Best Practices](#best-practices)

---

## Repository Setup

### Step 1: Create GitHub Repository

1. Go to https://github.com/new
2. Repository name: `aegg-new-app`
3. Description: `Sistema de GestiÃ³n de Trabajos Contables V2`
4. Visibility: **Private** (recommended for production)
5. **Do NOT** initialize with README (you already have code)
6. Click "Create repository"

### Step 2: Push Your Code

```bash
# On your local machine
cd aegg-new-app

# Initialize git (if not already done)
git init

# Add all files
git add .

# Commit
git commit -m "Initial commit: Add CI/CD configuration"

# Add remote
git remote add origin https://github.com/YOUR_USERNAME/aegg-new-app.git

# Push to GitHub
git push -u origin main
```

### Step 3: Verify Repository Structure

Your repository should have:

```
aegg-new-app/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml
â”‚       â”œâ”€â”€ deploy-production.yml
â”‚       â””â”€â”€ deploy-to-production.yml (old, can be deleted)
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ docker-compose.prod.yml
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ setup-vps.sh
â”‚       â”œâ”€â”€ backup.sh
â”‚       â””â”€â”€ generate-secrets.sh
â””â”€â”€ docs/
    â”œâ”€â”€ VPS-SETUP-GUIDE.md
    â””â”€â”€ GITHUB-SETUP-GUIDE.md
```

---

## GitHub Secrets Configuration

### Step 1: Navigate to Secrets Settings

1. Go to your repository on GitHub
2. Click **Settings** tab
3. In left sidebar, click **Secrets and variables** â†’ **Actions**
4. Click **New repository secret**

### Step 2: Add Required Secrets

Create the following secrets:

#### Database Secrets

| Name | Value | How to Generate |
|------|-------|-----------------|
| `DB_HOST` | `postgres` | Use this exact value |
| `DB_PORT` | `5432` | Use this exact value |
| `DB_USER` | `aegg_user` | Generate with `./deploy/scripts/generate-secrets.sh` |
| `DB_PASSWORD` | `<random password>` | Generate with `./deploy/scripts/generate-secrets.sh` |
| `DB_NAME` | `aegg_db` | Use this exact value |

#### JWT Secret

| Name | Value | How to Generate |
|------|-------|-----------------|
| `JWT_SECRET` | `<random string>` | Generate with `./deploy/scripts/generate-secrets.sh` |

#### VPS Connection Secrets

| Name | Value | How to Generate |
|------|-------|-----------------|
| `VPS_HOST` | `123.45.67.89` | Your VPS IP address or domain |
| `VPS_USER` | `aegg` | Deploy user on VPS |
| `VPS_PORT` | `22` | SSH port (default 22) |
| `VPS_SSH_KEY` | `<private key>` | Generate with `ssh-keygen` (see below) |

#### Application URLs

| Name | Value | How to Generate |
|------|-------|-----------------|
| `API_URL` | `https://aegg-api.creapolis.mx` | Your backend API URL |
| `FRONTEND_URL` | `https://aegg.creapolis.mx` | Your frontend URL |

#### Additional Secrets (Optional)

| Name | Value | Description |
|------|-------|-------------|
| `LETSENCRYPT_EMAIL` | `admin@example.com` | Email for SSL certificates |
| `GITHUB_TOKEN` | `<auto-generated>` | Auto-generated by GitHub Actions |

### Step 3: Generate SSH Key for VPS Access

**On your local machine:**

```bash
# Generate SSH key pair
ssh-keygen -t ed25519 -C "github-actions-aegg" -f ~/.ssh/aegg_github_actions

# Display public key
cat ~/.ssh/aegg_github_actions.pub
```

**Add public key to VPS:**

```bash
# Copy public key to VPS
ssh-copy-id -i ~/.ssh/aegg_github_actions.pub aegg@your-vps-ip

# Or manually add to VPS
cat ~/.ssh/aegg_github_actions.pub | ssh aegg@your-vps-ip "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

**Add private key to GitHub:**

1. Copy private key:
   ```bash
   cat ~/.ssh/aegg_github_actions
   ```

2. Go to GitHub repository: **Settings â†’ Secrets â†’ Actions**
3. Click "New repository secret"
4. Name: `VPS_SSH_KEY`
5. Paste the **entire** private key, including:
   ```
   -----BEGIN OPENSSH PRIVATE KEY-----
   ... key content ...
   -----END OPENSSH PRIVATE KEY-----
   ```
6. Click "Add secret"

### Step 4: Test SSH Access

```bash
# Test SSH connection from GitHub Actions runner
# (This will be tested when workflow runs)

# To test manually from local machine:
ssh -i ~/.ssh/aegg_github_actions aegg@your-vps-ip "echo 'SSH connection successful'"
```

---

## GitHub Actions Workflows

### Workflow 1: CI (Continuous Integration)

**File:** `.github/workflows/ci.yml`

**Triggers:**
- Push to `main` or `develop` branches
- Pull requests to `main` branch

**What it does:**
- âœ… Installs dependencies
- âœ… Lints code (backend + frontend)
- âœ… Runs tests (backend + frontend)
- âœ… Builds applications
- âœ… Type checks (frontend)
- âœ… Builds Docker images (CI only, doesn't push)

**When to use:**
- Every push to `main` or `develop`
- Every pull request
- To catch errors before deployment

### Workflow 2: Deploy to Production

**File:** `.github/workflows/deploy-production.yml`

**Triggers:**
- Push to `main` branch
- Manual trigger (workflow_dispatch)

**What it does:**
- âœ… Runs tests
- âœ… Builds Docker images
- âœ… Pushes images to GitHub Container Registry (GHCR)
- âœ… Deploys to VPS via SSH
- âœ… Runs database migrations
- âœ… Restarts services

**When to use:**
- Deploy to production
- After merging feature branch to `main`

---

## Container Registry Setup

### What is GitHub Container Registry (GHCR)?

GitHub Container Registry is a Docker registry integrated with GitHub, similar to Docker Hub but built into GitHub.

### Benefits:

- âœ… Integrated with GitHub permissions
- âœ… No separate authentication needed (uses `GITHUB_TOKEN`)
- âœ… Free for public repositories
- âœ… Generous limits for private repositories

### Workflow Permissions

**Configure permissions:**

1. Go to repository **Settings â†’ Actions â†’ General**
2. Scroll to "Workflow permissions"
3. Select:
   - âœ… **Read and write permissions**
4. Check:
   - âœ… **Allow GitHub Actions to create and approve pull requests**
5. Click "Save"

This allows GitHub Actions to push images to GHCR.

### View Container Images

After first deployment:

1. Go to repository on GitHub
2. Click on repository name dropdown (top of page)
3. Scroll to "Packages" section
4. You'll see:
   - `aegg-backend`
   - `aegg-frontend`

### Image Naming Convention

Images are tagged as:
- `ghcr.io/YOUR_USERNAME/aegg-backend:latest` (main branch)
- `ghcr.io/YOUR_USERNAME/aegg-backend:main-abc123def` (commit SHA)
- `ghcr.io/YOUR_USERNAME/aegg-frontend:latest`
- `ghcr.io/YOUR_USERNAME/aegg-frontend:main-abc123def`

---

## Testing CI/CD

### Test 1: Verify CI Workflow

```bash
# Create a test branch
git checkout -b test-ci

# Make a small change
echo "# Test" >> README.md

# Commit and push
git add README.md
git commit -m "test: verify CI workflow"
git push origin test-ci

# Create pull request on GitHub
# Or merge to main to trigger CI
```

**Verify:**
1. Go to **Actions** tab
2. Click on "ğŸ§ª CI" workflow
3. Verify all jobs pass:
   - Backend CI âœ…
   - Frontend CI âœ…
   - Docker Backend âœ…
   - Docker Frontend âœ…

### Test 2: Verify Deployment Workflow

```bash
# Ensure VPS is set up first (see VPS-SETUP-GUIDE.md)

# Merge test branch to main
git checkout main
git merge test-ci
git push origin main
```

**Verify:**
1. Go to **Actions** tab
2. Click on "ğŸš€ Deploy to Production" workflow
3. Verify all jobs pass:
   - Test & Migrations âœ…
   - Build Backend Image âœ…
   - Build Frontend Image âœ…
   - Deploy to VPS âœ…

4. SSH into VPS and verify:
   ```bash
   ssh aegg@your-vps-ip
   cd /opt/aegg
   docker-compose -f docker-compose.prod.yml ps
   ```

### Test 3: Manual Deployment Trigger

1. Go to **Actions** tab
2. Select "ğŸš€ Deploy to Production (VPS)" workflow
3. Click "Run workflow" button (right side)
4. Select branch: `main`
5. Click green "Run workflow" button

---

## Best Practices

### 1. Branch Protection Rules

**Configure:**

1. Go to **Settings â†’ Branches**
2. Click "Add rule"
3. Branch name pattern: `main`
4. Enable:
   - âœ… Require a pull request before merging
   - âœ… Require status checks to pass before merging
     - Select: `Backend CI`
     - Select: `Frontend CI`
   - âœ… Require branches to be up to date before merging
5. Click "Create"

### 2. Require Reviews for Production Changes

**Configure:**

1. In branch protection rule for `main`
2. Enable:
   - âœ… Require pull request reviews
   - Require **1** approval
   - Dismiss stale reviews when new commits are pushed

### 3. Keep Secrets Secure

**Rules:**
- âŒ **NEVER** commit secrets to repository
- âœ… Use GitHub Secrets for sensitive data
- âœ… Rotate secrets regularly (every 90 days)
- âœ… Use different secrets for different environments
- âœ… Never share screenshots with secrets visible

### 4. Monitor Workflow Runs

**Regularly check:**
- Workflow execution time
- Failed runs
- Security alerts (Dependencies tab)
- Container image sizes

### 5. Optimize Workflow Performance

**Already implemented:**
- âœ… Dependency caching (npm)
- âœ… Docker layer caching (gha)
- âœ… Parallel jobs execution
- âœ… Multi-stage Docker builds

**Additional optimizations:**
- Use `depends_on` to skip unnecessary jobs
- Use `concurrency: group` to cancel old runs
- Implement incremental builds

### 6. Use Semantic Versioning

**Tag releases:**

```bash
# Tag version
git tag -a v1.0.0 -m "Release version 1.0.0"

# Push tag
git push origin v1.0.0
```

**Update workflow to use tags:**

```yaml
tags:
  - type=semver,pattern={{version}}
  - type=semver,pattern={{major}}.{{minor}}
```

---

## Troubleshooting

### Issue: Workflow fails with "Permission denied"

**Solution:**

1. Check workflow permissions are set to "Read and write"
2. Re-generate `GITHUB_TOKEN` by re-running workflow
3. Verify repository secrets are correctly set

### Issue: Docker push fails with "denied"

**Solution:**

1. Verify `GITHUB_TOKEN` has write permissions
2. Check package visibility matches repository visibility
3. Ensure image names are correct:
   ```
   ghcr.io/YOUR_USERNAME/aegg-backend:latest
   ```

### Issue: SSH connection fails during deployment

**Solution:**

1. Test SSH key manually:
   ```bash
   ssh -i ~/.ssh/aegg_github_actions aegg@your-vps-ip
   ```

2. Verify `VPS_SSH_KEY` secret includes:
   - `-----BEGIN` line
   - Complete key content
   - `-----END` line

3. Check VPS firewall allows SSH (port 22)

### Issue: Deployment fails with "Database connection error"

**Solution:**

1. Verify database secrets are correct
2. Check database container is running:
   ```bash
   ssh aegg@vps "docker ps | grep postgres"
   ```

3. Review database logs:
   ```bash
   ssh aegg@vps "docker logs aegg-postgres"
   ```

### Issue: Images not updating on VPS

**Solution:**

1. Verify GHCR images were pushed:
   - Go to repository â†’ Packages
   - Check image tags

2. Force pull on VPS:
   ```bash
   ssh aegg@vps "cd /opt/aegg && docker-compose -f docker-compose.prod.yml pull"
   ```

3. Restart containers:
   ```bash
   ssh aegg@vps "cd /opt/aegg && docker-compose -f docker-compose.prod.yml up -d"
   ```

---

## CI/CD Pipeline Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Developer Push â”‚
â”‚   to main       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub Actions Triggered   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CI Workflow (.github/      â”‚
â”‚   workflows/ci.yml)          â”‚
â”‚                             â”‚
â”‚  âœ… Lint                    â”‚
â”‚  âœ… Test                    â”‚
â”‚  âœ… Build                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (if on main branch)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Deploy Workflow           â”‚
â”‚   (deploy-production.yml)   â”‚
â”‚                             â”‚
â”‚  1. Build Docker Images     â”‚
â”‚  2. Push to GHCR            â”‚
â”‚  3. Deploy to VPS via SSH   â”‚
â”‚  4. Run Migrations          â”‚
â”‚  5. Restart Services        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âœ… Deployment Complete    â”‚
â”‚                             â”‚
â”‚  Backend: aegg-api.domain   â”‚
â”‚  Frontend: aegg.domain      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitHub Container Registry](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
- [Docker Build Push Action](https://github.com/docker/build-push-action)
- [SSH Action](https://github.com/appleboy/ssh-action)

---

**Last Updated**: 2024-12-28
